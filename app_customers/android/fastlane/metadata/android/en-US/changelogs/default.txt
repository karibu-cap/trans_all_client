Minor bug fixes and speed improvements.
